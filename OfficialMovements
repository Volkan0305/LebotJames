%% Initialize Environment, UR5, and Omron Robots
clear; clc; close all;

% Initialize UR5 robot at the origin with base transformation
ur5BaseTr = transl(0.5, 0.5, 0);  % Base at origin
ur5Robot = LinearUR5(ur5BaseTr);  % Create instance of the LinearUR5 robot

% Initialize Omron robot at a shifted location
omronBaseTr = transl(1, 0, 0.5);  % Omron shifted along X-axis
omronRobot = Omron(omronBaseTr);  % Create instance of the Omron robot

%% Set the Desired Starting Position for the UR5 Robot
initialJointAnglesUR5 = [0, 0, -pi/2, 0, pi/2, pi/2, pi/2, pi];  % 8 joint values

% Plot the UR5 robot in the initial position
ur5Robot.model.plot(initialJointAnglesUR5);

%% Load and Plot the Ball (STL file)
ballPosition = transl(1.2, -0.5, 0.1);  % Ball initial position
ball = stlread('BasketTopu.stl');  % Load STL file
ballVertices = ball.Points * 0.0008;  % Scale vertices
ballFaces = ball.ConnectivityList;

% Plot the ball in the scene
hold on;
ballHandle = patch('Faces', ballFaces, 'Vertices', ballVertices + ballPosition(1:3, 4)', ...
    'FaceVertexCData', repmat([0.8, 0.3, 0.3], size(ballVertices, 1), 1), ...
    'FaceColor', 'flat', 'EdgeColor', 'none');

%% Set up Floor Texture and Environment
[X, Y] = meshgrid(-2:0.1:2, -2:0.1:2);
Z = zeros(size(X));
floorTexture = imread('concrete.jpg');  
surf(X, Y, Z, 'CData', floorTexture, 'FaceColor', 'texturemap', 'EdgeColor', 'none');
axis([-2 2 -2 2 0 2]);  
view(3);

%% Plot Initial Robot Configurations
omronRobot.PlotAndColourRobot();

%% Calculate Target Pose and Perform IK for Omron Robot
targetPose = transl(1.1, -0.4, 0.2);  % Adjusted ball position
qCurrent = omronRobot.model.getpos();
q0 = zeros(1, omronRobot.model.n);  % Initial joint configuration

try
    targetJointAngles = omronRobot.model.ikine(targetPose, q0, [1 1 1 0 0 0]);
catch
    targetJointAngles = omronRobot.model.ikcon(targetPose, q0);
end

steps = 50;
trajectory = jtraj(qCurrent, targetJointAngles, steps);
for i = 1:steps
    omronRobot.model.animate(trajectory(i, :));
    drawnow;
end

if isvalid(ballHandle)
    delete(ballHandle);  
    disp('Ball has been removed.');
end

%% Lift the Omron Robot Up
liftPose = targetPose * transl(0, 0, 1);
liftJointAngles = omronRobot.model.ikcon(liftPose, targetJointAngles);
liftSteps = 30;
liftTrajectory = jtraj(targetJointAngles, liftJointAngles, liftSteps);

for i = 1:liftSteps
    omronRobot.model.animate(liftTrajectory(i, :));
    drawnow;
end


%% Rotate Omron's Joints Sequentially
finalLiftAngles = liftJointAngles;
finalLiftAngles(1) = finalLiftAngles(1) - deg2rad(90);  % Rotate first joint

rotationTrajectory = jtraj(liftJointAngles, finalLiftAngles, 20);
for i = 1:20
    omronRobot.model.animate(rotationTrajectory(i, :));
    drawnow;
end

%% Rotate the Fifth Joint by -45 Degrees
fifthJointRotationSteps = 20;  
fifthJointAngles = finalLiftAngles;  

fifthJointAngles(5) = fifthJointAngles(5) + deg2rad(-45);
fifthJointTrajectory = jtraj(finalLiftAngles, fifthJointAngles, fifthJointRotationSteps);

for i = 1:fifthJointRotationSteps
    omronRobot.model.animate(fifthJointTrajectory(i, :));
    drawnow;
end

%% Rotate the Third Joint by -20 Degrees
thirdJointRotationSteps = 20;  
thirdJointAngles = fifthJointAngles;  

thirdJointAngles(3) = thirdJointAngles(3) + deg2rad(-20);
thirdJointTrajectory = jtraj(fifthJointAngles, thirdJointAngles, thirdJointRotationSteps);

for i = 1:thirdJointRotationSteps
    omronRobot.model.animate(thirdJointTrajectory(i, :));
    drawnow;
end

%% Rotate the Second Link by 70 Degrees
secondLinkRotationSteps = 20;  
finalRotationAngles = thirdJointAngles;  

finalRotationAngles(2) = finalRotationAngles(2) + deg2rad(70);
secondLinkTrajectory = jtraj(thirdJointAngles, finalRotationAngles, secondLinkRotationSteps);

for i = 1:secondLinkRotationSteps
    omronRobot.model.animate(secondLinkTrajectory(i, :));
    drawnow;
end 



%% Rotate the Second Link by 70 Degrees
secondLinkRotationSteps = 20;  
finalRotationAngles = thirdJointAngles;  

finalRotationAngles(2) = finalRotationAngles(2) + deg2rad(-70);
secondLinkTrajectory = jtraj(thirdJointAngles, finalRotationAngles, secondLinkRotationSteps);

for i = 1:secondLinkRotationSteps
    omronRobot.model.animate(secondLinkTrajectory(i, :));
    drawnow;
end 


%% UR5 Launch Sequence - Moving to Upright Position
initialAngles = [0, 0, -pi/2, 0, pi/2, pi/2, pi/2, pi];  % 8 joint values
finalAngles = [0, 0, -pi/9, 0, pi/2, pi/2, pi/2, pi];    % 8 joint values

qMatrix = jtraj(initialAngles, finalAngles, 100);
for i = 1:100
    ur5Robot.model.animate(qMatrix(i, :));
    pause(0.05);
end


%% Ball Launch Simulation
endEffectorPose = ur5Robot.model.fkine(finalAngles);
x0 = endEffectorPose.t(1);
y0 = endEffectorPose.t(2);
z0 = endEffectorPose.t(3);

v0 = 15;  
theta = pi;  
phi = pi/4;  
g = 9.81;  

t_end = 2;
timeSteps = linspace(0, t_end, 200);

scaled_vertices = ball.Points * 0.001;
hBall = patch('Faces', ball.ConnectivityList, 'Vertices', scaled_vertices, ...
    'FaceColor', [0.8 0.8 1.0], 'EdgeColor', 'none');

x_traj = zeros(size(timeSteps));
y_traj = zeros(size(timeSteps));
z_traj = zeros(size(timeSteps));

for i = 1:length(timeSteps)
    t = timeSteps(i);
    x_traj(i) = x0 + v0 * t * cos(theta) * cos(phi);
    y_traj(i) = y0;  
    z_traj(i) = z0 + v0 * t * sin(phi) - 0.5 * g * t^2;

    if z_traj(i) < 0
        x_traj = x_traj(1:i);
        y_traj = y_traj(1:i);
        z_traj = z_traj(1:i);
        break;
    end

    ballPosition = transl(x_traj(i), y_traj(i), z_traj(i));
    new_vertices = (ballPosition(1:3, 1:3) * scaled_vertices')' + ballPosition(1:3, 4)';
    set(hBall, 'Vertices', new_vertices);

    pause(0.005);
end

plot3(x_traj, y_traj, z_traj, 'r-', 'LineWidth', 2);
xlabel('X'); ylabel('Y'); zlabel('Z');
title('Ball Trajectory with STL Object');
grid on;

hold off;
